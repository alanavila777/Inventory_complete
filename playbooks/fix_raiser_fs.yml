---
- name: Prechecks for SLES12 to SLES15 OS Upgrade
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    current_date: "{{ ansible_facts['date_time']['date'] }}"
    output_file: /root/reiserfs_mounts.txt
    reiserfs_headroom_pct: 10
    vcenter_hostname: "192.168.1.102"
    vcenterUser: "svc_ansible@vsphere.local"
    vcenterPass: "Estratel.2025"
    vm_datacenter: "lab.local"
    validate_certs: false

  tasks:

    - name: set host shortname
      set_fact:
        host_shortname: "{{ inventory_hostname | regex_replace('(^[^\\.]*).*', '\\1') | upper }}"

################################### Set Default Vars ###################################

    - name: set vm_snapped default
      set_fact:
        vm_snapped: false

#################################### FIND VM(s) Folders, VCenter ####################################
 
    - name: Verify potential Snapshot Path for VM in DSC2 VCenter
      block:
        - name: Set VCenterName
          set_fact:
            VCenterName: "{{ vcenter_hostname }}"
     
    - name: Look for VM
      vmware_guest_find:
        hostname: "{{ VCenterName }}"
        username: "{{ vcenterUser }}"
        password: "{{ vcenterPass}}"
        name: "{{ host_shortname }}"
        validate_certs: no
      delegate_to: localhost
      register: VM_Search
      ignore_errors: true
     
    - name: Set VMFindFolderPath
      set_fact:
        VMFindFolderPath: "{{ VM_Search.folders[0] }}"
      when: VM_Search is succeeded
 
    - name: Set TargetSnapVcenter If Folder Found
      set_fact:
        TargetSnapVcenter: "{{ VCenterName }}"
      when: VM_Search is succeeded
 
    - name: Verify potential Snapshot Path for VM in DST2 VCenter
      block:
        - name: Set VCenterName
          set_fact:
            VCenterName: "{{vcenter_hostname}}"
     
    - name: Look for VM
      vmware_guest_find:
        hostname: "{{ VCenterName }}"
        username: "{{ vcenterUser }}"
        password: "{{ vcenterPass }}"
        name: "{{ host_shortname }}"
        validate_certs: no
      delegate_to: localhost
      register: VM_Search
      ignore_errors: true
     
    - name: Set VMFindFolderPath
      set_fact:
        VMFindFolderPath: "{{ VM_Search.folders[0] }}"
      when: VM_Search is succeeded
 
    - name: Set TargetSnapVcenter If Folder Found
      set_fact:
        TargetSnapVcenter: "{{ VCenterName }}"
      when: VM_Search is succeeded
 
    - name: "List VM, VCenter, and VM Folder Path"
      debug:
        msg:
        - "HostShortName = {{ host_shortname }}"
        - "TargetSnapVcenter = {{ TargetSnapVcenter }}"
        - "VMFindFolderPath = {{ VMFindFolderPath }}"
 
####################################  SNAPSHOT VM(s) ################################################
    - name: Set vm path variable
      set_fact:
        vm_path: "{{ VMFindFolderPath }}"
           
    - name: Extract folder and datacenter from path
      set_fact:    
        vm_folder: "{{ vm_path | regex_replace('^\\/(\\w*)', '\\1') }}"
        vm_datacenter: "{{ vm_datacenter }}"
 
    - name: Create pre-OS Migrate snapshot
      vmware_guest_snapshot:
        hostname: "{{ TargetSnapVcenter }}"
        username: "{{ vcenterUser }}"
        password: "{{ vcenterPass }}"
        datacenter: "{{ vm_datacenter }}"
        folder: "/{{ vm_folder }}"
        name: "{{ host_shortname }}"
        state: present
        snapshot_name: Ansible Pre-OS Boot Migration - {{ current_date }}
        description: Before applying OS Boot Migration - {{ ansible_date_time.date }}
        validate_certs: no
      delegate_to: localhost
      register: snap_json
 
    - name: Validate VM snapshot
      set_fact:
        vm_snapped: "{{ snap_json.changed }}"

################################ Scan Raiser FS ################################################
    - name: Get ReiserFS filesystems using df -Th
      ansible.builtin.shell: |
        set -o pipefail
        df -Th | awk '$2 == "reiserfs" {print $1, $7}'
      args:
        executable: /bin/bash
      register: reiserfs_df
      changed_when: false

    - name: Remove output file if no ReiserFS filesystems are found
      ansible.builtin.file:
        path: "{{ output_file }}"
        state: absent
      when: reiserfs_df.stdout | length == 0

    - name: Write device and mountpoint to output file
      ansible.builtin.copy:
        dest: "{{ output_file }}"
        content: "{{ reiserfs_df.stdout }}\n"
        owner: root
        group: root
        mode: "0600"
      when: reiserfs_df.stdout | length > 0

    - name: Get TOTAL ReiserFS size in bytes
      ansible.builtin.shell: |
        set -o pipefail
        df -BG -T | awk '$2=="reiserfs"{gsub("G","",$3); sum+=$3} END{print sum+0}'
      args:
        executable: /bin/bash
      register: reiserfs_df_gb
      changed_when: false

    - name: Set total ReiserFS size in GB
      ansible.builtin.set_fact:
        reiserfs_size_gb_total: "{{ reiserfs_df_gb.stdout | int }}"

    - name: Calculate required disk size in GB (TOTAL + headroom)
      ansible.builtin.set_fact:
        required_gb: "{{ (((reiserfs_size_gb_total | int) * (100 + (reiserfs_headroom_pct | int))) // 100) | int }}"
      when: (reiserfs_size_gb_total | int) > 0

    - name: Display calculation details
      ansible.builtin.debug:
        msg:
          - "ReiserFS filesystems found: {{ reiserfs_df.stdout_lines | length }}"
          - "Total ReiserFS SIZE (GB): {{ reiserfs_size_gb_total }}"
          - "Headroom percentage: {{ reiserfs_headroom_pct }}%"
          - "Final required disk size (GB): {{ required_gb }}"
      when: (reiserfs_size_gb_total | int) > 0
      changed_when: false

    - name: Display message if no ReiserFS detected
      ansible.builtin.debug:
        msg: "No ReiserFS filesystems were found on this system."
      when: (reiserfs_df_gb.stdout | int) == 0
      changed_when: false

  ##### ADD NEW DISK AND LVM IF SCAN FINDS REISERFS #########

    - name: Get disk info for VM
      vmware_guest_disk_info:
        hostname: "{{ TargetSnapVcenter }}"
        username: "{{ vcenterUser }}"
        password: "{{ vcenterPass }}"
        datacenter: "{{ vm_datacenter }}"
        folder: "/{{ vm_folder }}"
        name: "{{ host_shortname }}"
        validate_certs: no
      delegate_to: localhost
      register: vm_disk_info
      when:
        - (reiserfs_df_gb.stdout | int) > 0
        - (required_gb | int) > 0

    - name: Add disk (size = required_gb)
      vmware_guest_disk:
        hostname: "{{ TargetSnapVcenter }}"
        username: "{{ vcenterUser }}"
        password: "{{ vcenterPass }}"
        datacenter: "{{ vm_datacenter }}"
        folder: "/{{ vm_folder }}"
        name: "{{ host_shortname }}"
        disk:
          - size_gb: "{{ required_gb }}"
            datastore: "{{ vm_disk_info.guest_disk_info['0'].backing_datastore }}"
            scsi_controller: 0
            unit_number: "{{ (vm_disk_info.guest_disk_info | dict2items)[-1].value.unit_number + 1 }}"
            state: present
            type: thin
            scsi_type: paravirtual
            disk_mode: persistent
        validate_certs: no
      delegate_to: localhost
      when:
        - (reiserfs_df_gb.stdout | int) > 0
        - (required_gb | int) > 0

    - name: Get latest disk device name
      shell: lsblk -ndo NAME,TYPE | awk '$2 == "disk" {print $1}' | sort | tail -n1
      register: new_disk
      changed_when: false
 
    - name: Trigger SCSI scan (host0)
      shell: echo "- - -" > /sys/class/scsi_host/host0/scan
 
    - name: Show available disks after scan
      shell: fdisk -l | grep "Disk /dev/sd"
      register: disk_list
      changed_when: false
 
    - name: Create physical volume on new disk
      shell: pvcreate /dev/{{ new_disk.stdout }}
      when: new_disk.stdout != ""
     
    - name: Create volume group
      shell: vgcreate my-vg /dev/{{ new_disk.stdout }}
      when: new_disk.stdout != ""
 
    - name: Create logical volume 
      shell: lvcreate -n my-lv -l 100%FREE my-vg
      when: new_disk.stdout != ""
 
    - name: Create ext4 filesystem on new LV
      shell: mkfs.ext4 /dev/my-vg/my-lv
      when: new_disk.stdout != ""

    - name: Final summary
      ansible.builtin.debug:
        msg:
          - "ReiserFS detected â†’ disk added: {{ required_gb }} GB (based on TOTAL size + headroom)"
          - "New disk: {{ new_disk }}"
          - "Created LVM: /dev/my-vg/my-lv"
          - "Filesystem NOT created and NOT mounted."
      when: (reiserfs_df_gb.stdout | int) > 0
      changed_when: false
  vars:
    report_dir: "/root/host-inventory-list"
    report_file: "Linux_so_report.csv"
    report_path: "{{ report_dir }}/{{ report_file }}"

  tasks:
    - name: Ensure report directory exists on controller
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0700'
      delegate_to: localhost
      become: yes
      become_user: root
      run_once: true

    - name: Create CSV header if not exists (only once, on controller)
      ansible.builtin.lineinfile:
        path: "{{ report_path }}"
        line: "Hostname,OS Version,CPU Count,Total Memory (GB),Centrify Zone,Dynatrace Host Group"
        create: yes
        insertafter: BOF
      delegate_to: localhost
      become: yes
      become_user: root
      run_once: true

    - name: Append CSV row for this host on controller
      ansible.builtin.lineinfile:
        path: "{{ report_path }}"
        line: >-
          {{ inventory_hostname }},
          {{ current_os_version.stdout | default('') }},
          {{ current_cpu_count.stdout | default('') }},
          {{ current_total_memory.stdout | default('') }},
          {{ current_centrify_zone.stdout | default('') }},
          {{ current_dynatrace_host_group.stdout | default('') }}
        insertafter: EOF
        create: yes
      delegate_to: localhost
      become: yes
      become_user: root

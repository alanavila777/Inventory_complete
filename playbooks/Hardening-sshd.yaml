---
- name: Detect running sshd (OpenSSH vs Centrify) and harden MACs
  hosts: all
  become: true
  gather_facts: false

  vars:
    ssh_macs_line: >-
      MACs umac-128-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,umac-128@openssh.com,hmac-sha2-256,hmac-sha2-512

    sshd_map:
      /usr/sbin/sshd:
        cfg: /etc/ssh/sshd_config
        svc: sshd
      /usr/share/centrifydc/sbin/sshd:
        cfg: /etc/centrifydc/ssh/sshd_config
        svc: centrify-sshd

  handlers:
    - name: restart ssh
      ansible.builtin.service:
        name: "{{ sshd_service_name }}"
        state: restarted

  tasks:
    - name: Get sshd PID
      ansible.builtin.command: pgrep -x sshd
      register: sshd_pids
      changed_when: false

    - name: Resolve running sshd binary
      ansible.builtin.command: "readlink -f /proc/{{ sshd_pids.stdout_lines[0] }}/exe"
      register: sshd_bin
      changed_when: false

    - name: Set config/service from binary
      ansible.builtin.set_fact:
        sshd_running_bin: "{{ sshd_bin.stdout }}"
        sshd_config_path: "{{ sshd_map[sshd_bin.stdout].cfg | default('') }}"
        sshd_service_name: "{{ sshd_map[sshd_bin.stdout].svc | default('') }}"

    - name: Fail if unknown sshd binary
      ansible.builtin.fail:
        msg: "Unknown sshd binary running: {{ sshd_running_bin }}"
      when: sshd_service_name == ''

    - name: Ensure MACs line (backup enabled)
      ansible.builtin.lineinfile:
        path: "{{ sshd_config_path }}"
        regexp: '^[\s#]*MACs\s+'
        line: "{{ ssh_macs_line }}"
        insertafter: EOF
        backup: true
      notify: restart ssh

    - name: Validate sshd config (only OpenSSH)
      ansible.builtin.command: "sshd -t -f {{ sshd_config_path }}"
      changed_when: false
      when: sshd_running_bin == '/usr/sbin/sshd'

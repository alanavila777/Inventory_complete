---
- name: Gather SO Report from Hosts with PA Tag and Physical Hosts
  hosts: "physical-hosts:PA-tag-hosts"
  gather_facts: no

  vars:
    # RUTA MODIFICADA: Usamos /tmp para evitar problemas de permisos de escritura con el usuario awx/olam.
    report_dir: "/tmp/host-inventory-list" 
    report_file: "Linux_so_report.csv"
    report_path: "{{ report_dir }}/{{ report_file }}"

  tasks:
    # Tarea para ASEGURAR que el directorio existe
    - name: Ensure report directory exists
      file:
        path: "{{ report_dir }}"
        state: directory
      delegate_to: localhost
      run_once: true

    # TAREA NUEVA: Elimina el archivo anterior para asegurar que se sobrescriba.
    - name: Ensure old report file is deleted
      file:
        path: "{{ report_path }}"
        state: absent
      delegate_to: localhost
      run_once: true

    # Tarea para crear el encabezado CSV (que ahora se ejecuta siempre despuÃ©s de borrar el archivo)
    - name: Create CSV header
      lineinfile:
        path: "{{ report_path }}"
        line: "Hostname,OS Version,CPU Count,Total Memory (GB),Centrify Zone,Dynatrace Host Group"
        create: yes
        insertafter: BOF
      delegate_to: localhost
      run_once: true

    - name: Get OS Version
      shell: grep ^PRETTY_NAME= /etc/os-release | cut -d= -f2 | tr -d '"'
      register: current_os_version

    - name: Get CPU count
      shell: lscpu | awk '/^CPU\(s\):/ {print $2}'
      register: current_cpu_count

    - name: Get Total Memory in GB
      shell: awk '/MemTotal/ {printf "%.2f", $2/1024/1024}' /proc/meminfo
      register: current_total_memory

    - name: Get Centrify zone (if available)
      shell: /usr/bin/adinfo | awk -F'/' '/Zone/ {print $5}'
      register: current_centrify_zone
      failed_when: false
      changed_when: false

    - name: Get Dynatrace host group (if available)
      shell: /opt/dynatrace/oneagent/agent/tools/oneagentctl --get-host-group
      register: current_dynatrace_host_group
      failed_when: false
      changed_when: false

    - name: Append CSV row for this host on controller
      lineinfile:
        path: "{{ report_path }}"
        line: >-
          {{ inventory_hostname }},
          {{ current_os_version.stdout | default('') }},
          {{ current_cpu_count.stdout | default('') }},
          {{ current_total_memory.stdout | default('') }},
          {{ current_centrify_zone.stdout | default('') }},
          {{ current_dynatrace_host_group.stdout | default('') }}
        insertafter: EOF
      delegate_to: localhost
---
- name: Gather SO Report from Hosts with PA Tag and Physical Hosts
  hosts: "physical-hosts:PA-tag-hosts"
  gather_facts: no

  vars:
    report_dir: "/root/host-inventory-list"
    report_file: "Linux_so_report.csv"
    report_path: "{{ report_dir }}/{{ report_file }}"

  tasks:
    # 0) Ver si ya existe el CSV actual en el controlador
    - name: Check if current CSV exists on controller
      ansible.builtin.stat:
        path: "{{ report_path }}"
      delegate_to: localhost
      become: yes
      become_user: root
      run_once: true
      register: report_stat

    # 1) Si existe, renombrarlo con timestamp antes de generar uno nuevo
    - name: Backup previous CSV on controller with timestamp
      ansible.builtin.command: >
        mv {{ report_path }}
           {{ report_dir }}/Linux_so_report_{{ lookup('pipe','date +%Y%m%d%H%M%S') }}.csv
      delegate_to: localhost
      become: yes
      become_user: root
      run_once: true
      when: report_stat.stat.exists

    # 2) Asegurar que el directorio existe en el controlador
    - name: Ensure report directory exists on controller
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0700'
      delegate_to: localhost
      become: yes
      become_user: root
      run_once: true

    # 3) Crear el header del CSV NUEVO (se ejecuta una sola vez)
    - name: Create CSV header on controller
      ansible.builtin.lineinfile:
        path: "{{ report_path }}"
        line: "Hostname,OS Version,CPU Count,Total Memory (GB),Centrify Zone,Dynatrace Host Group"
        create: yes
        insertafter: BOF
      delegate_to: localhost
      become: yes
      become_user: root
      run_once: true

    # 4) Recolección de datos en cada host
    - name: Get OS Version
      ansible.builtin.shell: grep ^PRETTY_NAME= /etc/os-release | cut -d= -f2 | tr -d '"'
      register: current_os_version

    - name: Get CPU count
      ansible.builtin.shell: lscpu | awk '/^CPU\(s\):/ {print $2}'
      register: current_cpu_count

    - name: Get Total Memory in GB
      ansible.builtin.shell: awk '/MemTotal/ {printf "%.2f", $2/1024/1024}' /proc/meminfo
      register: current_total_memory

    - name: Get Centrify zone (if available)
      ansible.builtin.shell: /usr/bin/adinfo | awk -F'/' '/Zone/ {print $5}'
      register: current_centrify_zone
      failed_when: false
      changed_when: false

    - name: Get Dynatrace host group (if available)
      ansible.builtin.shell: /opt/dynatrace/oneagent/agent/tools/oneagentctl --get-host-group
      register: current_dynatrace_host_group
      failed_when: false
      changed_when: false

    # 5) Añadir una fila al CSV NUEVO por cada host
    - name: Append CSV row for this host on controller
      ansible.builtin.lineinfile:
        path: "{{ report_path }}"
        line: >-
          {{ inventory_hostname }},
          {{ current_os_version.stdout | default('') }},
          {{ current_cpu_count.stdout | default('') }},
          {{ current_total_memory.stdout | default('') }},
          {{ current_centrify_zone.stdout | default('') }},
          {{ current_dynatrace_host_group.stdout | default('') }}
        insertafter: EOF
        create: yes
      delegate_to: localhost
      become: yes
      become_user: root

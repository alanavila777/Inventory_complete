---
- name: Gather SO Report from Hosts with PA Tag and Physical Hosts
  hosts: "physical-hosts:PA-tag-hosts"
  gather_facts: yes

  vars:
    report_dir: "/root/host-inventory-list"
    report_file: "Linux_so_report.csv"
    report_path: "{{ report_dir }}/{{ report_file }}"

  tasks:
    - name: Check if current CSV exists on controller
      stat:
        path: "{{ report_path }}"
      delegate_to: localhost
      run_once: true
      register: report_stat

    - name: Backup previous CSV on controller with timestamp
      command: >
        mv {{ report_path }}
           {{ report_dir }}/Linux_so_report_{{ lookup('pipe','date +%Y%m%d%H%M%S') }}.csv
      delegate_to: localhost
      run_once: true
      when: report_stat.stat.exists

    - name: Ensure report directory exists on controller
      file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Create CSV header if not exists
      lineinfile:
        path: "{{ report_path }}"
        line: "Hostname,OS Version,CPU Count,Total Memory (GB),Centrify Zone,Dynatrace Host Group"
        create: yes
        insertafter: BOF
      delegate_to: localhost
      run_once: true

    - name: Get Centrify zone (if available)
      shell: /usr/bin/adinfo | awk -F'/' '/Zone/ {print $5}'
      register: current_centrify_zone
      failed_when: false
      changed_when: false

    - name: Get Dynatrace host group (if available)
      shell: /opt/dynatrace/oneagent/agent/tools/oneagentctl --get-host-group
      register: current_dynatrace_host_group
      failed_when: false
      changed_when: false

    - name: Append CSV row for this host on controller
      lineinfile:
        path: "{{ report_path }}"
        line: >-
          {{ inventory_hostname }},
          {{ ansible_distribution | default('') }} {{ ansible_distribution_version | default('') }},
          {{ ansible_processor_vcpus | default('') }},
          {{ (ansible_memtotal_mb | default(0) | float / 1024) | round(2) }},
          {{ current_centrify_zone.stdout | default('') }},
          {{ current_dynatrace_host_group.stdout | default('') }}
        insertafter: EOF
        create: yes
      delegate_to: localhost
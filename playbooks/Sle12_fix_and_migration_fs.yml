#### DETEC RAISER FS #####
---
- name: Detect ReiserFS mounts and save device + mountpoint
  hosts: all
  become: true
  gather_facts: false

  vars:
    output_file: /root/reiserfs_mounts.txt

  tasks:
    - name: Find ReiserFS entries from /proc/self/mounts
      ansible.builtin.shell: |
        set -o pipefail
        grep -w reiserfs /proc/self/mounts || true
      args:
        executable: /bin/bash
      register: reiserfs_grep
      changed_when: false

    - name: Build "DEVICE MOUNTPOINT" lines
      ansible.builtin.set_fact:
        reiserfs_lines: >-
          {{
            reiserfs_grep.stdout_lines
            | map('regex_replace', '^(\\S+)\\s+(\\S+).*$' , '\\1 \\2')
            | list
          }}
      changed_when: false

    - name: Show found ReiserFS filesystems (device + mountpoint)
      ansible.builtin.debug:
        msg:
          - "ReiserFS filesystem found:"
          - "Device     : {{ item.split(' ')[0] }}"
          - "Mount point: {{ item.split(' ')[1] }}"
          - "----------------------------------"
      loop: "{{ reiserfs_lines }}"
      when: reiserfs_lines | length > 0
      changed_when: false

    - name: Ensure output file is absent when no ReiserFS is found
      ansible.builtin.file:
        path: "{{ output_file }}"
        state: absent
      when: reiserfs_lines | length == 0

    - name: Write results to output file when ReiserFS is found
      ansible.builtin.copy:
        dest: "{{ output_file }}"
        content: "{{ reiserfs_lines | join('\n') }}\n"
        owner: root
        group: root
        mode: "0600"
      when: reiserfs_lines | length > 0

    - name: Final message
      ansible.builtin.debug:
        msg: >-
          {% if reiserfs_lines | length == 0 %}
          No ReiserFS filesystems were found on this system.
          {% else %}
          Results saved in: {{ output_file }}
          {% endif %}
      changed_when: false
